<html>
  <head>
	<title>Massive Chicken Fry</title>
	<script>

	 var Graphic = function (canvasName) {
	   this.canvas = document.getElementById(canvasName);
	   this.width = this.canvas.width;
	   this.height = this.canvas.height;
	   this.context = this.canvas.getContext("2d");

	   this.erase = function () {
		 this.context.fillStyle = "olivedrab";
		 this.context.fillRect(0, 0, this.width, this.height);
	   }
	 }
	 
	 var Board = function (width, height) {
	   this.width		= width;
	   this.height		= height;
	   this.tiles		= new Array();
	   //this.tileset	= new Array(); // Liste des images

	   for (var y = 0; y < this.height; y++) {
		 this.tiles[y]	= new Array();
		 for (var x = 0; x < this.width; x++) {
		   if (x == 0 || x == 9 || y == 0 || y == 9)
		   this.tiles[y][x] = 1;
		   else
		   this.tiles[y][x] = 0;
		 }
	   }

	   this.draw = function (graph) {
		 /*var image = new Image();
		 image.src = "file.jpg";
		 
		 graph.context.drawImage(image, 50, 50);*/
		 for (var y = 0; y < this.height; y++) {
		   for (var x = 0; x < this.width; x++) {
			 if (this.tiles[y][x] == 1) {
			   graph.context.fillStyle = "red";
			   graph.context.fillRect(x * 64, y * 64, 64, 64);
			 }
		   }
		 }
	   }
	 }

	 colorPlayer = [
	   "blue", "red", "orange", "green", "pink"
	 ]

	 var Player = function (id, pseudo, x, y, color, score) {
	   this.id = id;
	   this.pseudo = pseudo;
	   this.x = x;
	   this.y = y;
	   this.score = score;
	   this.color = color;
	   //this.image = new Image();
	   //this.image.src = "image.png";

	   this.move = function (x, y) {
		 this.x += x;
		 this.y += y;
	   }

	   this.draw = function (graph) {
		 //graph.context.drawImage(this.image, this.x, this.y);
		 graph.context.fillStyle = colorPlayer[this.color];
		 graph.context.beginPath();
		 graph.context.arc(this.x, this.y, 32, 0, 2 * Math.PI);
		 graph.context.stroke();
		 graph.context.fill();
	   }
	 }
	 
	 ws = null;
	 board = null;
	 graphic = null;
	 players = new Array();

	 function toggleInfo(connected) {
	   var overlay = document.getElementById("boardOverlay");
	   var joinButton = document.getElementById("joinButton");
	   var connection = document.getElementById("connection");

	   if (connected) {
		 overlay.style.display = "none";
		 connection.style.display = "block";
		 joinButton.disabled = false;
	   } else {
		 overlay.style.display = "block";
		 connection.style.display = "none";
		 joinButton.display = true;
	   }
	 }

	 function addPlayerOnList(player) {
	   var playerNode = document.createElement("div");
	   playerNode.setAttribute("id", "player" + player.id);
	   playerNode.setAttribute("class", "player");
	   playerNode.style.backgroundImage = "linear-gradient(to right, " + colorPlayer[player.color] +
										  " 0%, white 20%, white 100%)";
	   
	   var nameNode = document.createElement("div");
	   nameNode.setAttribute("class", "playerName");
	   nameNode.innerHTML = player.pseudo;
	   playerNode.appendChild(nameNode);
	   
	   var scoreNode = document.createElement("div");
	   scoreNode.setAttribute("class", "playerScore");
	   scoreNode.innerHTML = "" + player.score;
	   playerNode.appendChild(scoreNode);

	   var listPlayers = document.getElementById("listPlayers");
	   listPlayers.appendChild(playerNode);
	 }
	 
	 function connectServer() {
	   if (ws){ return };
	   
	   ws = new WebSocket('ws://mfc.lo:5000');
	   console.log(ws);
	   ws.onmessage = function (e) {
		 //console.log("Receive: " + event.data);
		 var gameState = JSON.parse(e.data);
		// alert(gameState.count);
		 console.log(gameState);
		 if (gameState.board && gameState.board.tiles) {
		   board.tiles = gameState.board.tiles;
		   board.draw(graphic);
		 }
		 if (gameState.players) {
		   for (var i = 0; i < gameState.players.length; i++) {
			 var newPlayer = gameState.players[i];
			 var player = new Player(newPlayer.id, newPlayer.pseudo,
									 newPlayer.x * 64 + 32, newPlayer.y * 64 + 32,
									 newPlayer.color, newPlayer.score);
			 player.draw(graphic);
			 addPlayerOnList(player);
		   }
		 }
	   };
	   ws.onopen = function (e) {
		 console.log("Socket opened");
		 
		 toggleInfo(true);
	   };
	   ws.onclose = function (e) {
		 console.log("Socket closed");
		 toggleInfo(false);
		 ws = null;
	   };
	   ws.onerreur = function (e) {
		 console.log("Socket error: " + e);
		 toggleInfo(false);
		 ws = null;
	   };
	 }

	 function keydown(e) {
	   switch (e.keyCode) {
		 case 39:		// Right
		 case 37:		// Left
		 case 38:		// Up
		 case 40:		// Down
		 case 32:		// Space
				   if (ws) {
					 var data = {
					   "event": "keydown",
					   "key": e.keyCode
					 }
					 ws.send(JSON.stringify(data));
				   }
			break;
		 default:
			console.log("unknown key: " + e.keyCode);
	   }
	   
	   return false;
	 }
	 
	 function init() {
	   graphic = new Graphic("boardCanvas");
	   graphic.erase();
	   board = new Board(10, 10);
	   board.draw(graphic);

	   connectServer();
	   
	   var join = document.getElementById("join");
	   join.addEventListener("submit", function (e) {

		 var login = document.getElementById("login");
		 if (login.value != "") {
		 /*	ws.send(login.value);*/
		 	ws.onJoin=function(e){
		 		 var gameState = JSON.parse(e.data);
		// alert(gameState.count);
		 console.log(gameState);
		 if (gameState.board && gameState.board.tiles) {
		   board.tiles = gameState.board.tiles;
		   board.draw(graphic);
		 }
		 if (gameState.players) {
		   for (var i = 0; i < gameState.players.length; i++) {
			 var newPlayer = gameState.players[i];
			 var player = new Player(newPlayer.id, newPlayer.pseudo,
									 newPlayer.x * 64 + 32, newPlayer.y * 64 + 32,
									 newPlayer.color, newPlayer.score);
			 player.draw(graphic);
			 addPlayerOnList(player);
		   }
		 }
		 	};
		   alert("Bienvenu a " + login.value);
		   //ws.close();
		 } else {
		   alert("Vous devez rentrer un pseudo !");
		 }		 
	   }, false);

	   var connect = document.getElementById("connect");
	   connect.addEventListener("click", function (e) {
		 connectServer();
	   });

	   var canvas = document.getElementById("boardCanvas");
	   canvas.tabIndex = 1000;
	   canvas.addEventListener("keydown", keydown, false);
	   canvas.focus();
	 }

	 window.onload = init;
	</script>

	<style>
	 #container {
	   margin: 0 auto;
	 }
	 #board {
	   width: 640px;
	   height: 640px;
	   position: relative;
	   float: left;
	 }
	 #boardOverlay {
	   width: 100%;
	   height: 100%;
	   z-index: 10;
	   position: absolute;
	   top: 0;
	   left: 0;
	   display: block;
	   background-color: rgba(0, 0, 0, 0.5);
	 }
	 #boardConnection {
	   font-size: 20px;
	   color: white;
	 }
	 #connection {
	   display: none;
	   float: left;
	   margin-left: 20px;
	 }
	 #listPlayers {
	   width: 250px;
	   float: left;
	   margin-left: 20px;
	 }
	 .player {
	   background-image: linear-gradient(to right, blue 0%, white 20%, white 100%);
	   height: 20px;
	   padding-left: 50px;
	   margin-top: 5px;
	 }
	 .playerName {
	   float: left;
	 }
	 .playerScore {
	   float: right;
	 }
	</style>
  </head>
  <body>
	<div id="container">
	  <div id="board">
		<div id="boardOverlay">
		  <div id="boardConnection">
			<div id="boardOverlayMessage">Erreur lors de la connection</div>
			<button id="connect">Connect...</button>
		  </div>
		</div>
		<canvas id="boardCanvas" width="640" height="640">
		  Voyez utiliser un vrai navigateur ! Bande de looser !
		</canvas>
	  </div>
	  <div id="connection">
		<form id="join">
		  <input id="login" placeholder="Enter your login..." />
		  <button id="joinButton" disabled="true" type="submit">Join</button>
		</form>
	  </div>
	  <div id="listPlayers">
	  </div>
	</div>
  </body>
</html>
